# 클로저 (Closure)

> 클로저가 뭐야? 라고 물어봤을 때 어떻게 대답할지 생각해보자.

## 한줄 요약

"모던 자바스크립트 튜토리얼"에서는
> 외부 변수를 기억하고 이에 접근할 수 있는 함수를 의미한다.

"You don't know JS"에서는
> 함수가 속한 렉시컬 스코프를 기억하여 함수가 렉시컬 스코프 밖에서 실행될 때에도 이 스코프에 접근할 수 있게 하는 기능을 뜻한다.

이렇게 정리하고 있다. <br>
이제서야 보니 두 문장이 같은 의미라는 것을 알 수 있겠다.

## 클로저가 가능한 이유

클로저의 대표 예시 코드를 먼저 보자.
```JS
// 모던 자바스크립트 튜토리얼에서 따온 코드
function makeCounter() {
    let count = 0;
    return function() {
        return count++;
    }
}
let counter = makeCounter();
alert(counter());
// counter가 호출될 때 과연 count 변수를 가져올 수 있을까?
```
자바스크립트는 모든 함수가 자연스럽게 클로저가 된다.

자바스크립트는 수행 중인 함수, 코드 블록, 스크립트 전체는 렉시컬 환경이라는 숨겨진 객체를 가지고 있다.

### 렉시컬 환경
렉시컬 환경은 이렇게 구성되어있다.
- 환경 레코드 : 로컬 변수에 대해 저장하고 있음
- 외부 렉시컬 환경 (외부 코드)에 대한 레퍼런스

함수가 호출 중인 동안은 호출 중인 함수, 렉시컬 환경이 가리키고 있는 외부 환경에 대한 정보를 얻을 수 있다.

```JS
// 이 예시는 You don't know JS 206쪽에서 가져옴 
// ------------------------------- 1
function foo(a) { 
    var b = a * 2; // ------------ 2
    function bar(c) { // --------- 3
        console.log(a, b, c);
    }
    bar(b * 3);
}
foo(2);
// 1번은 글로벌 스코프를 감싸고, foo만 있다.
// 2번은 foo 스코프를 감싸고, a, bar, b가 있다.
// 3번은 bar 스코프를 감싸고, c만을 포함한다.
// bar(b * 3); 코드가 실행됐을 때 변수 b는 같은 스코프 내에서 찾을 수 있다.
// 그럼 그 다음 a는?? 가장 가까운 스코프로 한단계 올라가서 찾게 된다.
// 찾을 때까지 계속 올라가게 된다.
// 렉시컬 환경이 외부 렉시컬 환경을 가리키고 있기 때문에 가능하다.
```

### 클로저 다시 정리해보기

```JS
// 모던 자바스크립트 튜토리얼에서 따온 코드
function makeCounter() {
    let count = 0;
    return function() { 
        // 이 함수는 mokeCounter 실행될 때 실행은 안 되지만 생성되고
        // 생성될 때 성성된 곳의 렉시컬 환경을 기억하고 있다.
        // [[Environment]]라 불리는 숨김 프로퍼티가 있어서
        // 여기에 렉시컬 환경에 대한 참조가 저장된다.
        // [[Environment]]로 상단 스코프 count에 대한 정보를 접근할 수 있다!
        // 변수 값을 변경하면 어떻게 될까?
        // 변수가 저장되어 있는 렉시컬 환경에서 이루어진다.
        return count++;
    }
}
let counter = makeCounter();
alert(counter());
```

## 참고
- [모던 자바스크립트 튜토리얼 - 변수의 유효범위와 클로저](https://ko.javascript.info/closure)
- YOU DON'T KNOW JS (타입과 문법, 스코프와 클로저 편)